<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="admin">

	<!-- 검색 시 유저 이름 또는 아이디로 검색 -->
	<sql id="where-list">
	  <if test="searchKey=='userName'">
	      userName=#{searchValue}
	  </if>
	  <if test="searchKey=='userId'">
	      userId=#{userId}
	  </if>
	  <if test="searchKey=='clubName'">
	      clubName=#{clubName}
	  </if>
	</sql>
	
	
	<!-- 회원 수 -->
	<select id="memberCount" parameterType="map"
	            resultType="Integer">
	  SELECT COUNT(*) FROM memberInfo
	     <where>
	     	<if test="searchValue!=null and searchValue!='' ">
	     	    <include refid="where-list"/>
	     	</if>
	     </where>   
	</select>
	
	<!-- 회원 리스트 -->
	<select id="memberList" parameterType="map"
	            resultType="com.bong.admin.Member">
		SELECT * FROM (
		    SELECT ROWNUM rNum, tb.* FROM (
			     SELECT ci.userIdx, userId, userTel, userName, userGender, userLevel,
           NVL(userNoshow, 0) userNoshow, userScore,
           TO_CHAR(created_date, 'YYYY-MM-DD') created_date
           ,TO_CHAR(last_Login, 'YYYY-MM-DD') last_Login
			        FROM checkId ci
              		JOIN memberinfo mi ON ci.userIdx=mi.userIdx
                    <where>
                         <if test="searchValue != null and searchValue != ''">
			                  <include refid="where-list"/>
		                 </if>
	                </where>
	                ORDER BY userIdx DESC
	<![CDATA[
	        ) tb WHERE ROWNUM <= #{end}
	    ) WHERE rnum >= #{start}
	]]>
	</select>
	
	<!-- 클럽 수 -->
	<select id="clubCount" parameterType="map"
	            resultType="Integer">
	  SELECT COUNT(*) FROM clubInfo
	     <where>
	     	<if test="searchValue!=null and searchValue!='' ">
	     	    <include refid="where-list"/>
	     	</if>
	     </where>   
	</select>
	
	<!-- 동아리 리스트 -->
	<select id="listClub" resultType="com.bong.admin.Club" 
	          parameterType="map">
		SELECT * FROM (
		    SELECT ROWNUM rnum, tb.* FROM (
		        SELECT tot.*, ct2.subject as lSubject, ct1.subject as sSubject  FROM
     					 (SELECT clubName, TO_CHAR(clubBirth, 'YYYY-MM-DD') clubBirth, clubAddr, userId, closed, prologue, introduce, themeNum,                  
			          	NVL(cvl.total_hours, 0) total_hours, NVL(cvl.total_NoShow, 0) total_NoShow, NVL(jc.member, 0) member FROM clubinfo ci
			         	LEFT OUTER JOIN (SELECT SUM(clubhours) total_hours, SUM(clubnoshow) total_noshow, clubIdx FROM clubVolList
						GROUP BY clubIdx) cvl ON ci.clubIdx=cvl.clubIdx
          				LEFT OUTER JOIN (SELECT COUNT(userIdx) member, clubIdx FROM joinclub
						GROUP BY clubIdx) jc ON ci.clubIdx=jc.clubIdx) tot
			            LEFT OUTER JOIN theme ct1 ON tot.themenum=ct1.themenum
			            LEFT OUTER JOIN theme ct2 ON ct1.parent=ct2.themenum
	<![CDATA[
	        ) tb WHERE ROWNUM <= #{end}
	    ) WHERE rnum >= #{start}
	]]>
	</select>
	<!-- 수요처 수 -->
	<select id="demanderCount" parameterType="map"
	            resultType="Integer">
	  SELECT COUNT(*) FROM serviceinfo si
      JOIN checkId ci ON si.userIdx = ci.userIdx
      WHERE isService=#{switching}
	     <where>
	     	<if test="searchValue!=null and searchValue!='' ">
	     	    <include refid="where-list"/>
	     	</if>
	     </where>   
	</select>
	
	<!-- 수요처 리스트 -->
	<select id="listDemander" resultType="com.bong.admin.Demander"
			parameterType="map">
		SELECT * FROM(
			SELECT ROWNUM rnum, tb.* FROM(
					SELECT si.serviceIdx, ci.userId, si.serviceName, TO_CHAR(si.serviceBirth, 'YYYY-MM-DD') serviceBirth,
				       si.serviceTel, si.serviceAddr, si.serviceEmail, ci.isService,
				       t2.subject lSubject, t1.subject sSubject
				       FROM checkId ci
               		   JOIN serviceInfo si ON ci.userIdx=si.userIdx
				       LEFT OUTER JOIN theme t1 ON si.themeNum=t1.themeNum
				       LEFT OUTER JOIN theme t2 ON t1.parent=t2.themeNum
				       WHERE ci.isService=#{switching}
	<![CDATA[
	        ) tb WHERE ROWNUM <= #{end}
	    ) WHERE rnum >= #{start}
	]]>		
	</select>
	
	
</mapper>